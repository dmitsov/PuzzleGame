<!DOCTYPE html>
<html>
<head>
	<title>Puzzle Game</title>
<link href="/bootstrap/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <div class="container panel">
  	<canvas class="row lead" id="Puzzle" width="600" height="600"></canvas><br/>
    <form action="/logout" method="POST">
      <input class="btn btn-default row col-md-4" type="submit" value="Logout" id="logout">
    </form>
  </div>
  
 

  <div class="container" style="postion: relative;margin-left:750px;margin-top:-630px;">
    <table clas="row table tables-striped table-responsive" id="moveTable">

    </table><br/>
    <button class="btn btn-defualt" id="prev">Prev</button>
    <button class="btn btn-defualt" id="next">Next</button>
    <button class="btn btn-defualt" id="del">Delete Game</button>
  </div>


  <script src="/js/jquery-1.10.2.min.js"></script>
  <script src="http://code.jquery.com/jquery-migrate-1.2.1.js"></script>
  <script src="/js/jquery.mustache.js"></script>
  <script src="/js/mustache.js"></script>
  <script src="/js/jquery.color.js"></script>



  <script id="moveTemplate" type="text/html">
      <tr data-move='{{Move}}' data-indexes='{{Indexes}}' data-pos='{{Positions}}'>
          <td>{{Move}}</td> 
      </tr>

  </script>

	<script type="text/javascript">
  $.Mustache.addFromDom();
 
  var isSecond = 0;
  var move = 1;
  var moves = [];
  var nextHiden = false;
	function ImgMovable(x,y,source){
		this.image = null;
		this.x = x;
		this.y = y;
    this.num = null;
		
	}
  

  var mail = document.cookie.split("=")[1].split(":")[0].replace("\"","");

      var images = {};
      var start = new Date().getTime();
	    function loadImages(sources,callback) {
        var numberOfSources = 0;
        var loadedImages = 0;
                
        for(var src in sources){
            numberOfSources++
        }



        var y = 0;
        var x = 0;
        var count = 0;
        var index = 1;


        for(var src in sources){
          images[src] = new ImgMovable(0,0);
          images[src].image = new Image();
          images[src].image.onload = function(data) {
            if(numberOfSources <= ++loadedImages){
      	 	   callback(images);
            }
          };

          if(sources[src] != ""){
            images[src].image.src = sources[src];
          }
          images[src].num = index++;
        }
      }

  
      var canvas = document.getElementById('Puzzle');
      var context = canvas.getContext('2d');
    	

      var sources = {
        darthVader: 'http://www.html5canvastutorials.com/demos/assets/darth-vader.jpg',
        yoda: 'http://www.html5canvastutorials.com/demos/assets/yoda.jpg',
        obi_wan: 'http://img3.wikia.nocookie.net/__cb20111208191614/starwars/tr/images/5/5a/Obi2.jpg',
        count_dooku: 'http://img3.wikia.nocookie.net/__cb20091216160323/swfanon/images/thumb/b/b3/CountDooku.jpg/250px-CountDooku.jpg',
        mace_windu: 'http://s2.quickmeme.com/img/36/36da73b03a3c8ba42912be0c03046ca891dd5156b1bce6789d3460fae46fe566.jpg',
        darth_sidious: 'https://encrypted-tbn1.gstatic.com/images?q=tbn:ANd9GcTbGmtoIhg6lhwgDPdRgz6ohNyN8G0lvuPbaZP651xFDQUEGFFs8A',
        luke: 'http://img4.wikia.nocookie.net/__cb20080319003050/starwars/nl/images/8/84/Lukeskywalker.jpg',
        jar_jar: 'http://media.comicbook.com/wp-content/uploads/2013/03/Jar-Jar-Binks-Top-Tenz.jpg'
      };
          useAjax("GET","/getSaveGame?Username_mail=" + mail,null,function(data){
            move = data ? data.length: 0;
            moves = data;
            $('#moveTable').mustache('moveTemplate',data);
          });
  
        loadImages(sources,function(data){
          images = shuffle(images);
          var tempx = 0;
          var tempy = 0;
          var count = 0;
          if(move == 0){  
            for(var img in images){
              images[img].x = tempx;
              images[img].y = tempy;

              tempx += 200;
              if((++count) == 3){
                tempy+=200;
                tempx = 0;
                count = 0;
              }
            }
            var i = 0;
            var positions = [];  
            var indexes=[];  
            for(var img in images){
              indexes[i] = images[img].num;
              positions[i] = [images[img].x,images[img].y];
              i++;
            }
            ++move;
            var saveGame = {
              "Username_mail": mail,
              "Move" : move,
              "Indexes" : indexes.toString(),
              "Positions": positions.toString()
            };
            useAjax("POST","/saveGame",saveGame,null);
            useAjax("GET","/getSaveGame?Username_mail=" + mail,null,function(data){
                $("#moveTable").empty();
                $("#moveTable").mustache('moveTemplate',data);
            });
            moves[move-1] = saveGame;
          } else {
            var element = $('[data-move=' + move + ']');
            var indexes = JSON.parse("[" + element.first().data('indexes') + "]");
            var pos = JSON.parse("[" + element.first().data('pos') + "]");

            var posx, posy;
            for(var img in images){
              for(var i = 0; i < indexes.length; i++){
                if(images[img].num == indexes[i]){
                  images[img].x = pos[i*2];
                  images[img].y = pos[i*2+1];
                }
              }
            }
          }
          for(var src in images){
            context.drawImage(images[src].image,images[src].x,images[src].y,200,200);
          }
      });    

    $("#del").click(function(){
      useAjax("DELETE","/deleteGame?Username_mail=" + mail,null,function(){
        move = 1;
        $("#moveTable").empty();
      });
    });

    $("#next").click(function(){
        if(move < $('td').length)
        move++;
        //$('td').css({color: 'black'});
        $('tr').animate({color: 'black'});
        $("[data-move="+move+"]").animate({color: 'red'});
        var element = $('[data-move=' + move + ']');
        var indexes = JSON.parse("[" + element.first().data('indexes') + "]");
        var pos = JSON.parse("[" + element.first().data('pos') + "]");

        for(var img in images){
          for(var i = 0; i < indexes.length; i++){
            if(images[img].num == indexes[i]){
              images[img].x = pos[i*2];
              images[img].y = pos[i*2+1];
            }
          }
        }
        redrawCanvas(images);
    });

    $("#prev").click(function(){
        if(move > 1)
          move--;
     
        $('tr').animate({color: 'black'});
        $("[data-move="+move+"]").animate({color: 'red'});
        var element = $('[data-move=' + move + ']');
        var indexes = JSON.parse("[" + element.first().data('indexes') + "]");
        var pos = JSON.parse("[" + element.first().data('pos') + "]");
        if(nextHiden){
          $('#next').show();
        }
        nextHiden = false;

        for(var img in images){
          for(var i = 0; i < indexes.length; i++){
            if(images[img].num == indexes[i]){
              images[img].x = pos[i*2];
              images[img].y = pos[i*2+1];
            }
          }
        }
        redrawCanvas(images);
        
    });


    $("#Puzzle").click(function(){
        var img = null;
        var x = event.pageX - $("#Puzzle").position().left;
        var y = event.pageY - $("#Puzzle").position().top;
 
        for(var image in images){
          var isIn = isImageClicked(x,y,images[image]) 
          if(isIn){

              img = images[image];
          }
        }
        if(img != null)
          goToFreeSpace(img);
        else return;
      
        
        var temp = [];    
        for(var i = 0; i < move; i++){
            temp[i] = moves[i];
        }

        moves = temp;

        var i = 0;
        var positions = [];  
        var indexes=[];  
        for(var img in images){
          indexes[i] = images[img].num;
          positions[i] = [images[img].x,images[img].y];
          i++;
        }
        move++;
        var savedMove = {
          "Username_mail": mail,
          "Move" :move,
          "Indexes": indexes.toString(),
          "Positions": positions.toString()

        }
        moves[move-1] = savedMove;
        
        useAjax("DELETE","/deleteGame?Username_mail=" + mail,null,function(){
          useAjax("POST","/saveGames",moves,function(){
            useAjax("GET","/getSaveGame?Username_mail="+mail,null,function(data){
              $("#moveTable").empty();
              $("#moveTable").mustache('moveTemplate',data);
            });
          }); 
        });
        
        if(checkIfOrdered(images)){
          var json = {
              "Username_mail" : mail,
              "Highscore" : ((new Date().getTime()) - start)*10
          }
          useAjax("POST","/updateScore",json,null);
        }
    
        nextHiden = true;
        $('#next').hide();
      });

   
    function redrawCanvas(images){
      var canvas = document.getElementById('Puzzle');
      var context = canvas.getContext('2d');
      context.clearRect(0,0,canvas.width,canvas.height);

      for(var img in images){
         context.drawImage(images[img].image, images[img].x,images[img].y,200,200);
      }
    }

    function isImageClicked(x,y,image){
      return (image.x < x) && (image.y < y) &&
             (x < (image.x + 200)) && (y < (image.y + 200));
    }

    function goToFreeSpace(image){
        var length = 200;
        
        var top = image.y == 0;
        var left = image.x == 0;
        var bottom = image.y == 400;
        var right = image.x == 400;

        for(var img in images){
            if(images[img].y == (image.y - length) && images[img].x == image.x){
              top = true;
            }

            if(images[img].x == (image.x + length) && images[img].y == image.y){
              right = true;
          
            }

            if(images[img].y == (image.y + length) && images[img].x == image.x){
              bottom = true;
            }

            if(images[img].x == (image.x - length) && images[img].y == image.y){
              left = true;
            }
          
        }

        if(!top){
          animate(image,"y",-200);    
        } else if(!right){
          animate(image,"x",200);    
     
        } else if(!bottom){
          animate(image,"y",200);    
     
        } else if(!left){
          animate(image,"x",-200);    
        }

       // redrawCanvas(images)

    }

    function useAjax(method,urlString,dataString,callback){
        $.ajax({
           type: method,
           url: urlString,
           data: dataString ? JSON.stringify(dataString) : "",
           dataType: 'json', 
           contentType:"application/json; charset=UTF-8"
        }).done(function(data){
            if(callback){
              callback(data)
            }
        });
    }

    function animate(image,axis,delta){
        
          if(axis == "x"){
            image.x += delta;
          } else if(axis == "y"){
            image.y += delta;
          }

          redrawCanvas(images);
    }

    function sleep(miliseconds){
      var startTime = new Date().getTime();

      while(true){
          if((new Date().getTime() - startTime) >= miliseconds){
            break;
          }
      }
    }

    function shuffle(imgs){
      var temp = {};
      var tempLength = 0
      while(tempLength < 8){
        var num = randNumTo8();
        for(var img in imgs){
          if(imgs[img].num == num){
            if(!checkIfUsed(temp,num)){
              temp[img] = imgs[img];
              tempLength++;
            }
          }
        }
      }
      return temp;
    }

    function checkIfOrdered(imgs){
      for(var img in imgs){
          if(imgs[img].num == 1){
            if(imgs[img].x == 0 && imgs[img].y == 0){
              break;
            } else return false;
          }
      }

      for(var img in imgs){
          if(imgs[img].num == 2){
            if(imgs[img].x == 200 && imgs[img].y == 0){
              break;
            } else return false;
          }
      }
      
      for(var img in imgs){
          if(imgs[img].num == 3){
            if(imgs[img].x == 400 && imgs[img].y == 0){
              break;
            } else return false;
          }
      }

      for(var img in imgs){
          if(imgs[img].num == 4){
            if(imgs[img].x == 0 && imgs[img].y == 200){
              break;
            } else return false;
          }
      }
      
      for(var img in imgs){
          if(imgs[img].num == 5){
            if(imgs[img].x == 200 && imgs[img].y == 200){
              break;
            } else return false;
          }
      }
      
      for(var img in imgs){
          if(imgs[img].num == 6){
            if(imgs[img].x == 400 && imgs[img].y == 200){
              break;
            } else return false;
          }
      }
      
      for(var img in imgs){
          if(imgs[img].num == 7){
            if(imgs[img].x == 0 && imgs[img].y == 400){
              break;
            } else return false;
          }
      }
      
      for(var img in imgs){
          if(imgs[img].num == 8){
            if(imgs[img].x == 200 && imgs[img].y == 400){
              break;
            } else return false;
          }
      }
      

      return true;
    }

    function checkIfUsed(imgs, num){
      for(var img in imgs){
        if(imgs[img].num == num)
          return true;
      }
      return false;
    }

    function randNumTo8(){
      return Math.floor((Math.random()*8)+1);
    }

    function findImage(x,y){
      for(var img in images){
        if(images[img].x == x){
          if(images[img].y == y){
            return images[img];
          }
        }
      }
    }
	</script>

</body>


</html>